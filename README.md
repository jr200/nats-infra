# nats-infra

The `compose-infra.yaml` file starts the following infrastructure:
- Zitadel + Postgres DB
- a NATS server
- a NATS server admin pod (for managing operator/accounts/users using `nsc`)

## NATS server Configuration

The NATS server configuration file is generated by `nsc-admin/init.sh`, and stored in a docker volume.

## Zitadel Configuration

Initial setup steps:
- nativate to: http://localhost:8888
- the first time login is: `zitadel-admin@zitadel.localhost`/`Password1!`
- login as admin and create a new user for testing

Login as admin, then:
- create a project
- for each user/api/service account
    - create an application, i.e., web/pkce
    - configuration:
        - redirect settings:
            - check box: development mode
            - setup redirect: http://localhost:3000/api/auth/callback/zitadel
            - setup post-logout: http://localhost:3000/
        - save client id, client secret, etc
        - enable refresh token
        - response types: Code
    - token settings:
        - auth token type: JWT
        - check box: User Info inside ID Token

## Scripts


### scripts/nats-create-account.sh

This script creates a local NATS operator, account, and user in a local development environment. It then imports the account's public key *into* a running NATS server. This allows users generated by the local account to access resources on the NATS server--as granted by the account and user permissions/limits.

First set some required environment variables.

```bash
export OPERATOR_NAME=local-operator
export ACCOUNT_NAME=MY-TEAM
export USER_NAME=static-user
export NATS_CONTAINER=infra-team-nats-1
export NSC_CONTAINER=infra-team-nsc-admin-1
export NATS_URL=nats://127.0.0.1:4222
export CONTAINER_CLI=podman
```

Then run the script to setup the operator, account and optional user credentials. If a `USER_NAME` is specified, it's credentials will be output to stdout.
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/jr200/nats-infra/main/scripts/nats-create-account.sh)"
```

### scripts/nats-enable-auth-callout.sh

Given a local NATS operator, account and user, this script:

- enables auth-callout feature on the (account, user)
- outputs to the specified folder:
    - the auth-callout user credentials
    - the auth-callout sentinel credentials (permissionless)
    - the nats-to-'auth-callout-service' encryption keys
    - signing keys for the auth-callout account

First set some required environment variables.

```bash
export OPERATOR_NAME=local-operator
export ACCOUNT_NAME=MY-TEAM
export USER_NAME=ac-user
export NATS_CONTAINER=infra-team-nats-1
export NSC_CONTAINER=infra-team-nsc-admin-1
export OUTPUT_DIR=./nats-secrets
export NATS_URL=nats://127.0.0.1:4222
export CONTAINER_CLI=podman
```

Then run the script to update the account, and write the required secrets to the supplied `OUTPUT_DIR`.
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/jr200/nats-infra/main/scripts/nats-enable-auth-callout.sh)"
```

### scripts/nats-fetch-signing-creds.sh

```bash
export OPERATOR_NAME=local-operator
export ACCOUNT_NAME=MY-TEAM
export OUTPUT_DIR=./nats-secrets
```
Then run the script to write the (locally stored) signing keys for the specified accounts to the supplied `OUTPUT_DIR`.

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/jr200/nats-infra/main/scripts/nats-fetch-signing-creds.sh)"
```
